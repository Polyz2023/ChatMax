<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Maximum</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: rgb(68, 61, 73);
            
        }
       .cbt {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
       .container {
            background-color: rgb(33, 33, 33);
            border-radius: 0% 0% 1% 1%;
            color: aliceblue;
        }
        #all_mess {
            max-height: 320px;
            overflow-y: auto;
           
        }
    </style>
</head>
<body>

    <div class="conteiner">
        <div class="d-flex justify-content-center align-items-center flex-column cbt ">

            <div class="container text-center mt-3" style="background-color: rgb(26, 26, 26);">
                <h2>Чат</h2>
                <h6>v2.3.0</h6>
                <p class="lead" id="oni">Онлайн людей в чате: 0</p>
            </div>

            <div class="container" style="height: 400px;">
                <div class="row">
                    <div class="col-6">
                        <h3>Сообщения</h3>
                        <div id="all_mess"></div>
                    </div>
                </div>
            </div>

            <div class="container" style="background-color: rgb(26, 26, 26);">
                <h3>Форма сообщений</h3>
                <form id="messForm">
                    <div class="form-group">
                        <label for="name">Имя</label>
                        <input type="text" id="name"name="name" class="form-control" style="color:white;background-color: rgb(60, 60, 60);">
                    </div>
                    <div class="form-group">
                        <label for="message" id="soob">Сообщение</label>
                        <textarea name="message" id="message"class="form-control" style="color:white;background-color: rgb(60, 60, 60);"s></textarea>
                    </div>
                    <input type="submit" value="Отправить" class="btn btn-danger">
                    <a type="button" href="/chatm1" class="btn btn-info">Сменить версию чата (не рекомендовано)</a>
                    <input type="file" id="file" value="Загрузить фото" class="btn btn-warning">
                </form>
            </div>

        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        var isOTVET=true;
        var otsv="" ;
        function otvet(e) {
            console.log(e.textContent);
            var sob = document.getElementById('soob');
            sob.innerText = `Ответ → ` + `${e.textContent}`;
            isOTVET = false;
            otsv = e.textContent.trim(); // Обновление переменной otsv с текстом оригинального сообщения
            console.log(otsv, isOTVET);
        }

       $(function(){
            var socket = io();
            var $form = $('#messForm');
            var $textarea = $('#message');
            var $name = $('#name');
            var $all_messages = $('#all_mess');
            var $oni = $('#oni');
            var $file = $('#file');
            let hours;
            let minutes;// Определение переменных в глобальной области видимост

            $form.submit(function(event) {
                event.preventDefault();
                const now = new Date();
                hours = now.getHours();
                minutes = now.getMinutes();
                hours = hours < 10 ? '0' + hours : hours;
                minutes = minutes < 10 ? '0' + minutes : minutes;

                if (isOTVET) {
                    socket.emit('send mess', {
                        mess: $textarea.val(),
                        name: $name.val(),
                        hours: hours,
                        minutes: minutes
                    });
                } else {
                    console.log("Ответ на:", otsv); // Добавьте эту строку для отладки
                    socket.emit('sendo mess', {
                        mess: $textarea.val(),
                        name: $name.val(),
                        hours: hours,
                        minutes: minutes,
                        o: otsv
                    });
                }

                $textarea.val('');
            });

            $(document).keydown(function(event){
        // Проверяем, нажата ли клавиша Enter (код клавиши 13) и активен ли элемент с id "message"
                if (event.keyCode === 13 && event.target.id === 'message') {
                    event.preventDefault();
                    const now = new Date(); // Получаем текущее время
                    hours = now.getHours(); // Получаем часы
                    minutes = now.getMinutes(); // Получаем минуты
                    hours = hours < 10 ? '0' + hours : hours; // Добавляем ноль перед часами, если это нужно
                    minutes = minutes < 10 ? '0' + minutes : minutes; // Добавляем ноль перед минутами, если это нужно

                    if(isOTVET){
                        socket.emit('send mess', {
                            mess: $textarea.val(), 
                            name: $name.val(), 
                            hours: hours, 
                            minutes: minutes
                        });
                    }else{
                        socket.emit('sendo mess', {
                            mess: $textarea.val(), 
                            name: $name.val(), 
                            hours: hours, 
                            minutes: minutes,
                            o: otsv
                        });
                    }

                    $textarea.val('');
                }
            });

            socket.on('add mess', (data) => {
                console.log("Received message on client:", data);
                let now = new Date(); // Получаем текущее время
                let hours = now.getHours(); // Получаем часы
                let minutes = now.getMinutes(); // Получаем минуты
                hours = hours < 10 ? '0' + hours : hours; // Добавляем ноль перед часами, если это нужно
                minutes = minutes < 10 ? '0' + minutes : minutes; // Добавляем ноль перед минутами, если это нужно
                
                // Отображаем обычные сообщения
                $all_messages.append("<div onclick='otvet(this)' class='alert alert-dark'><b>"+ data.name+ " (" + hours + ":" + minutes + "): " +"</b>" + data.msg +"</div>");
                
                $all_messages.scrollTop($all_messages[0].scrollHeight);
            });

            socket.on('adds mess', (data) => {
                $all_messages.append(`<div onclick='otvet(this)' class='alert alert-dark'><i>Ответ → '${data.o}'→ </i><b>${data.name} (${data.hours}:${data.minutes}): ${data.msg}</b></div>`);
                $all_messages.scrollTop($all_messages[0].scrollHeight);
                isOTVET = true;
                document.getElementById('soob').innerText = "Сообщение";
            });


            socket.on('onu', (data)=>{
                $oni.text("Онлайн людей в чате: " + data);
            });

            document.getElementById('file').addEventListener('change', function(event) {
                var file = event.target.files[0];
                var reader = new FileReader();
                
                reader.onload = function(e) {
                    var base64 = e.target.result;
                    socket.emit('send image', {image: base64, name: $name.val()});
                };
                
                reader.readAsDataURL(file);
            });

            socket.on('add image', (data) => {
                console.log("Received image on client:", data);
                $all_messages.append(`<div class='alert alert-dark'><b>${data.name}(${hours}:${minutes}):</b> <img src="${data.image}" style="max-width:200px;"></div>`);
                $all_messages.scrollTop($all_messages[0].scrollHeight);
            });

        });

    </script>
</body>
</html>